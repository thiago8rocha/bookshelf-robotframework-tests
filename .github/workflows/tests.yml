name: ü§ñ Robot Framework Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tests/**'
      - 'resources/**'
      - 'base/**'
      - '*.resource'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-tests:
    name: üß™ Run All Tests
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: thiago8rocha/bookshelf-api
          path: bookshelf-api

      - name: üì• Checkout Frontend
        uses: actions/checkout@v4
        with:
          repository: thiago8rocha/bookshelf-frontend
          path: bookshelf-frontend

      - name: üì• Checkout Robot Tests
        uses: actions/checkout@v4
        with:
          path: bookshelf-tests

      - name: üê≥ Start Application via Docker Compose
        working-directory: bookshelf-tests
        run: |
          docker compose -f docker-compose.ci.yml up -d --build database backend frontend
          echo "Aguardando servi√ßos ficarem saud√°veis..."
          for i in $(seq 1 30); do
            HEALTHY=$(docker compose -f docker-compose.ci.yml ps | grep -c "healthy" || true)
            TOTAL=$(docker compose -f docker-compose.ci.yml ps | grep -c "Up\|running" || true)
            echo "‚è≥ Servi√ßos saud√°veis: $HEALTHY ($i/30)"
            if [ "$HEALTHY" -ge 3 ]; then
              echo "‚úÖ Todos os servi√ßos est√£o saud√°veis"
              break
            fi
            sleep 5
          done

      - name: üß™ Run Tests
        working-directory: bookshelf-tests
        run: |
          docker compose -f docker-compose.ci.yml run --rm robot
        continue-on-error: true
        id: run_tests

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: bookshelf-tests/results/
          retention-days: 30

      - name: üìà Test Report Summary
        if: always()
        working-directory: bookshelf-tests
        run: |
          echo "## üß™ Resultados dos Testes" >> $GITHUB_STEP_SUMMARY
          if [ -f results/output.xml ]; then
            python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('results/output.xml')
          stats = tree.find('.//statistics/total/stat')
          passed = stats.get('pass', '0')
          failed = stats.get('fail', '0')
          skipped = stats.get('skip', '0')
          total = int(passed) + int(failed) + int(skipped)
          print(f'| Total | Passou | Falhou | Pulou |')
          print(f'|---|---|---|---|')
          print(f'| {total} | ‚úÖ {passed} | ‚ùå {failed} | ‚è≠Ô∏è {skipped} |')
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Arquivo de resultados n√£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üßπ Cleanup
        if: always()
        working-directory: bookshelf-tests
        run: docker compose -f docker-compose.ci.yml down -v

      - name: ‚ùå Fail if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1