name: ğŸ¤– Robot Framework Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tests/**'
      - 'resources/**'
      - 'base/**'
      - '*.resource'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  run-tests:
    name: ğŸ§ª Run Tests (excludes stress & slow)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Backend
        uses: actions/checkout@v4
        with:
          repository: thiago8rocha/bookshelf-api
          path: bookshelf-api

      - name: ğŸ“¥ Checkout Frontend
        uses: actions/checkout@v4
        with:
          repository: thiago8rocha/bookshelf-frontend
          path: bookshelf-frontend

      - name: ğŸ“¥ Checkout Robot Tests
        uses: actions/checkout@v4
        with:
          path: bookshelf-tests

      - name: ğŸ³ Start Application via Docker Compose
        working-directory: bookshelf-tests
        run: |
          docker compose -f docker-compose.ci.yml up -d --build database backend frontend
          echo "Aguardando serviÃ§os ficarem saudÃ¡veis..."
          for i in $(seq 1 30); do
            HEALTHY=$(docker compose -f docker-compose.ci.yml ps | grep -c "healthy" || true)
            echo "â³ ServiÃ§os saudÃ¡veis: $HEALTHY ($i/30)"
            if [ "$HEALTHY" -ge 3 ]; then
              echo "âœ… Todos os serviÃ§os estÃ£o saudÃ¡veis"
              break
            fi
            sleep 5
          done

      - name: ğŸ§ª Run Tests
        working-directory: bookshelf-tests
        # Exclui 'stress' (thresholds tolerantes, documentaÃ§Ã£o de limite)
        # e 'slow' (soak tests de 12min â€” rodam no schedule semanal)
        run: |
          docker compose -f docker-compose.ci.yml run --rm robot \
            python -m robot \
              --exclude stress \
              --exclude slow \
              --listener allure_robotframework \
              -d results \
              tests/
        continue-on-error: true
        id: run_tests

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: bookshelf-tests/results/
          retention-days: 30

      - name: ğŸ“ˆ Test Report Summary
        if: always()
        working-directory: bookshelf-tests
        run: |
          echo "## ğŸ§ª Resultados dos Testes" >> $GITHUB_STEP_SUMMARY
          if [ -f results/output.xml ]; then
            python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('results/output.xml')
          stats = tree.find('.//statistics/total/stat')
          passed = stats.get('pass', '0')
          failed = stats.get('fail', '0')
          skipped = stats.get('skip', '0')
          total = int(passed) + int(failed) + int(skipped)
          print(f'| Total | Passou | Falhou | Pulou |')
          print(f'|---|---|---|---|')
          print(f'| {total} | âœ… {passed} | âŒ {failed} | â­ï¸ {skipped} |')
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Arquivo de resultados nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”§ Install Allure CLI
        if: always()
        run: |
          sudo apt-get update -q
          sudo apt-get install -y -q default-jre
          ALLURE_VERSION=2.29.0
          wget -q "https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz"
          tar -zxf allure-${ALLURE_VERSION}.tgz
          sudo mv allure-${ALLURE_VERSION} /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      - name: ğŸ“Š Generate Allure report
        if: always()
        run: |
          allure generate bookshelf-tests/results -o allure-report --clean

      - name: ğŸ“¤ Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      - name: ğŸ§¹ Cleanup
        if: always()
        working-directory: bookshelf-tests
        run: docker compose -f docker-compose.ci.yml down -v

      - name: âŒ Fail if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1

  deploy-pages:
    name: ğŸŒ Deploy Allure to GitHub Pages
    runs-on: ubuntu-latest
    needs: run-tests
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4