name: ‚è∞ Scheduled Tests

on:
  schedule:
    # Diariamente √†s 3h AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - regression
          - smoke
          - fresh-user
          - negative

jobs:
  scheduled-tests:
    name: ‚è∞ Scheduled - ${{ github.event.inputs.test_type || 'all' }}
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          path: bookshelf-tests

      - name: üê≥ Start Application via Docker Compose
        working-directory: bookshelf-tests
        run: |
          docker compose -f docker-compose.ci.yml up -d --build database backend frontend
          echo "Aguardando servi√ßos ficarem saud√°veis..."
          docker compose -f docker-compose.ci.yml wait backend frontend || true
          sleep 10

      - name: üß™ Run Tests
        working-directory: bookshelf-tests
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
          if [ "$TEST_TYPE" = "all" ]; then
            docker compose -f docker-compose.ci.yml run --rm robot
          else
            docker compose -f docker-compose.ci.yml run --rm robot \
              python -m robot --include $TEST_TYPE -d results tests/
          fi
        continue-on-error: true
        id: run_tests

      - name: üìä Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scheduled-results-${{ github.run_number }}
          path: bookshelf-tests/results/
          retention-days: 30

      - name: üìß Criar Issue em caso de falha
        if: steps.run_tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Scheduled Tests Failed',
              body: `Testes agendados falharam em ${new Date().toISOString()}
              
              **Execu√ß√£o:** [Ver Resultados](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              Verifique os artefatos da execu√ß√£o para detalhes.`,
              labels: ['automated-test', 'bug']
            })

      - name: üßπ Cleanup
        if: always()
        working-directory: bookshelf-tests
        run: docker compose -f docker-compose.ci.yml down -v

      - name: ‚ùå Fail if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1
